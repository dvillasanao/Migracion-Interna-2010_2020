---
title: "Movilidad Laboral 2020"
author: "CONAPO"
output:
   html_document:
      highlight: tango
      theme: flatly
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: yes
---

\usepackage{color}

```{=html}
<style>
code.r{
  font-size: 10px;
}
pre {
  font-size: 12px
}
</style>

<style>
body {
text-align: justify;
font-style: normal;
font-family: "Montserrat";
font-size: 12px
}
h1.title {
  font-size: 40px;
  color: #000D3B;
}
h1 {
  color: #B6854D;
}
h2 {
  color: #172984;
}
h3 {
  color: #172984;
}
</style>
```

```{=html}
<style>
.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #0A2687;
}
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    background-color: #09C2BC;
}
</style>
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                         eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   
 

```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
showtext_auto()
#font_add_google("Montserrat", "montserrat")
#font_add_google("Raleway", "Raleway")
loadfonts(device = "win")
font.add("montserrat", regular = 'C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/Montserrat-Light.ttf')
```

```{r, echo = FALSE}
# Librerías que se usaron en el documCVE_ENTo
require(chorddiag)
require(circlize)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(ggalluvial)
require(ggsankey)
require(ggrepel)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
```


**Cuestionario Ampliado del Censo de Población y Vivienda 2020**

El cuestionario ampliado se guarda en un un archivo `.RData`. 

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
      file = paste0(here::here(),"/Bases/Censo_Personas_2020.RData"))
```


Se seleccionan las variables que se desean conservar para la realización de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos. 

La variable `mydata` contiene **15 015 683 observaciones** y **33 variables**.      

**Posibles variables que se pueden contemplar en la migración laboral** 

- `NIVACAD` ¿Cuál fue el último año o grado aprobado por (NOMBRE) en la escuela?  
- `CONACT` Situación laboral    
- `OCUPACION_C` Cuál fue la ocupación de (NOMBRE) la semana pasada? Por ejemplo: técnico electricista, maestra de primaria, vendedora de frutas, albañil, mecánico de autos    
- `SITTRA`  Situación de trabajo    
- `VACACIONES`   
- `SERVICIO_MEDICO`   
- `INCAP_SUELDO` 
- `INGTRMEN`   
- `ACTIVIDADES_C` ¿A qué se dedica el negocio, empresa o lugar donde trabajó (NOMBRE)? Por ejemplo: hacer muebles de madera, hacer escobas, reparar autos, vender ropa usada, armar televisores..    
- `TIE_TRASLADO_TRAB`   
- `MED_TRASLADO_TRAB1`  
- `MED_TRASLADO_TRAB2`   
- `MED_TRASLADO_TRAB3`    
  

```{r, eval = FALSE}
load(paste0(here::here(),"/Bases/Censo_Personas_2020.RData"))
mydata <- data %>%
           select(CVE_ENT, ENT, MUN, CVE_MUN, ENT_PAIS_TRAB, MUN_TRAB, CVE_MUN_TRABAJO, 
                  EDAD, SEXO, AFRODES, HLENGUA, QDIALECT_INALI, PERTE_INDIGENA, NIVACAD, ALFABET, 
                  CAUSA_MIG, SITUA_CONYUGAL, HIJOS_NAC_VIVOS, CONACT, OCUPACION_C, SITTRA, VACACIONES, 
                  SERVICIO_MEDICO, INCAP_SUELDO, INGTRMEN, ACTIVIDADES_C, TIE_TRASLADO_TRAB,  
                  MED_TRASLADO_TRAB1, MED_TRASLADO_TRAB2, MED_TRASLADO_TRAB3, FACTOR, ESTRATO, UPM)

save(mydata, file = paste0(here::here(),"/Bases/03_Movilidad laboral_2020.RData"))
```


Se carga el archivo `Migracion laboral_2020.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/03_Migracion laboral_2020.RData"))

# Para fines prácticos se genera un ponderador de uno 
mydata <- mydata %>% 
           select(CVE_ENT, ENT, MUN, CVE_MUN, ENT_PAIS_TRAB, MUN_TRAB, CVE_MUN_TRABAJO, 
                  CONACT, EDAD, FACTOR, ESTRATO, UPM) %>%
            mutate(M = 1)  %>%
             mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
              ungroup()
```



**Entidades**

Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.     
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines prácticos.     
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.   

```{r}
nom_estados <- sjlabelled::get_labels(mydata$ENT)
estados <- sjlabelled::get_labels(mydata$ENT)
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO", "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los municipios
municipios <- sjlabelled::get_labels(mydata$CVE_MUN) %>% as.factor()
#saveRDS(municipios, file = paste0(here::here(), "/Bases/municipios_2020.RDS"))

# Se le asignan las etiquetas a los nombres de los estados 
levels(mydata$NOM_ENT) <- estados
```


**Población ocupada de 15 años y más **    

Se identifica a la población ocupada de 15 años y más. 

`filter((EDAD >= 15 & EDAD != 999) & (CONACT >= 10 & CONACT <= 20))'.`    

```{r}
# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

Pob.ocupada <- mydata %>%
                as.data.frame() %>%
                 mutate(EDAD = as.numeric(.$EDAD)) %>%
                  subset((EDAD >= 15 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                   filter(ENT_PAIS_TRAB %in% tablas)  # Filtro del lugar de trabajo dentro del país. 
```

**Población ocupada de 15 años y más** 


```{r, echo = FALSE}
# Población ocupada de 15 años y más
tabla <- mydata %>%
          as.data.frame() %>%
           mutate(EDAD = as.numeric(.$EDAD)) %>%
            subset((EDAD >= 15 & EDAD <= 130)) %>%
             summarise(P.15ymas = sum(.$FACTOR))
        
as.integer(tabla) %>%  
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none"))) %>%
   gt() %>% 
    tab_header(title = "Población ocupada de 15 años y más") %>%
     tab_options(heading.title.font.size = 12, 
                 heading.align = "center",
                 heading.subtitle.font.size = 10,
                 table.align = "center",
                 column_labels.font.weight = "bold",
                 table.font.names = 'montserrat',
                 table.font.size = 8) %>%  
       as_raw_html()
```

**Población economicámente activa de 15 años y más** 


```{r, echo = FALSE}
# Población economicámente activa de 15 años y más
tabla <- Pob.ocupada %>%
          summarise(P.ocupada = sum(.$FACTOR))

as.integer(tabla) %>%  
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none"))) %>%
   gt() %>% 
    tab_header(title = "Población economicámente activa de 15 años y más") %>%
     tab_options(heading.title.font.size = 12, 
                 heading.align = "center",
                 heading.subtitle.font.size = 10,
                 table.align = "center",
                 column_labels.font.weight = "bold",
                 table.font.names = 'montserrat',
                 table.font.size = 8) %>%  
       as_raw_html()
```

# Muestro Complejo 

Se utiliza la paquetería `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a la población ocupada de 15 años y más.   

```{r, eval = FALSE}
options(survey.lonely.psu = "adjust")

MC <- Pob.ocupada %>%
       svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)
saveRDS(MC, file = paste0(here::here(), "/Output/Estado/03_Movilidad laboral/2020/MC_estado.RDS"))
```


# Nivel estatal {.tabset .tabset-pills}

## Migración laboral  {.tabset .tabset-pills}  

Se genera una matriz cruzada de migración laboral a nivel estatal, utilizando la función `svytable` de la paquetería `survey`.  

```{r}
MC <- readRDS(file = paste0(here::here(), "/Output/Estado/03_Movilidad laboral/2020/MC_estado.RDS"))

Migrantes <- svytable(~ENT_PAIS_TRAB + CVE_ENT, design = MC)
```

Se quita la diagonal a la matriz cruadrada y se le asignan los nombres de los estados.  

```{r}
tabla <- Migrantes %>%
          as.data.frame() %>%
           expss::cross_cases(CVE_ENT, ENT_PAIS_TRAB, weight = Freq) %>%
            as.data.frame() %>%
             slice(-33) %>% 
              select(-row_labels) 

rownames(tabla)<- stringr::str_wrap(estados, 50)
colnames(tabla) <- stringr::str_wrap(estados, 50)

wb <- createWorkbook()
addWorksheet(wb, "MTrabajo 2020")
writeData(wb, 1, tabla, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(), "/Bases/Estado/03_Movilidad laboral/2020/Matriz de MTrab a nivel estatal 2020.xlsx"), overwrite = TRUE)
```


**Matriz de migración laboral a nivel estatal, 2020**  


<div style="height:500px;overflow:auto;">
```{r, echo = FALSE}
tabla <- tabla %>%
          as.data.frame() %>%
           tibble::rownames_to_column() 

tabla %>%  
 gt() %>% 
   tab_header(title = "Matriz de migración laboral, 2020", 
              subtitle = "Nivel estatal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
     tab_style(style = list(cell_text(align = "center",
                                      weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
      tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
       sub_missing(columns = everything(), missing_text = "0") %>%
        as_raw_html()
```
</div>


## Gráfico dinámico 

Gráfico dinámico de migración laboral a nivel estatal.

```{r, fig.width=7, fig.height=5, fig.align='center'}
#devtools::install_github("mattflor/chorddiag")
require(chorddiag)

tabla <- Migrantes %>%
          as.data.frame() %>%
           expss::cross_cases(CVE_ENT, ENT_PAIS_TRAB, weight = Freq) %>%
            as.data.frame() %>%
             slice(-33) %>% 
              select(-row_labels) %>%
               sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(estados, 15)
colnames(tabla) <- stringr::str_wrap(estados, 15)

groupColors <- viridis::viridis(32, option = "A")


p <- chorddiag(tabla, 
               groupColors = groupColors, 
               groupnamePadding = 10, 
               height = 600, 
               width = 600,
               margin = 160,
               groupThickness = 0.05,
               groupPadding = 1,
               groupnameFontsize = 10,
               fadeLevel = 0.2,
               chordedgeColor = "#D0D0CF", 
               showTicks = TRUE)

p
require(htmlwidgets)
htmlwidgets::saveWidget(p, paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/MTrab a nivel estatal 2020.html"), selfcontained = TRUE)
#require(webshot)
#webshot(url = paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/MTrab a nivel estatal 2020.html"),
 #         file = paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/MTrab a nivel estatal 2020.png"),
  #                cliprect = "viewport")
```

## Gráficos migración laboral {.tabset .tabset-pills}

### ChordDiagram 

```{r, eval = FALSE}
tabla <- Migrantes %>%
          as.data.frame() %>%
           expss::cross_cases(ENT, ENT_PAIS_TRAB, weight = Freq) %>%
            as.data.frame() %>%
             slice(-32) %>% 
              select(-row_labels) %>%
               sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(estados, 15)
colnames(tabla) <- stringr::str_wrap(estados, 15)
```


```{r, fig.height=20, fig.width=20, eval = FALSE, class.source = "fold-hide"}
# Paleta de colores
groupColors <- viridis::viridis(32, option = "A")

circos.clear()
#svglite::svglite(paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/ChordDiagram de MTrab a nivel estatal.svg"), width = 20, height = 20)
pdf(paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/ChordDiagram de MTrab a nivel estatal.pdf"), width = 20, height = 20)
circos.par(start.degree = 90, 
           gap.degree = 3, 
           track.margin = c(-0.1, 0.1), 
           points.overflow.warning = FALSE)

par(mar = rep(0, 4))

chordDiagram(x  = tabla, 
             grid.col = groupColors,
             order = union(rownames(estados), colnames(estados)),
             keep.diagonal = FALSE,
             transparency = 0.25,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04,
             annotationTrack = "grid", 
             annotationTrackHeight = mm_h(c(10)),
             preAllocateTracks = 1, 
             big.gap = 40,
             link.arr.type = "big.arrow", 
             link.lwd = 0.5,
             link.visible = TRUE,
             link.largest.ontop = FALSE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                      # track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                   # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.5, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.01, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(20),
                                                               col = groupColors,
                                                              font = 2)
                                                   # Add graduation on axis
                                                    circos.axis(h = "top",
                                                                labels = c(0, 20, 50, 70, 100, 500, 1000, 5000, 10000,30000,50000,100000, 200000),
                                                                major.tick.length = 0.5,
                                                                minor.ticks = 4, 
                                                                labels.cex = fontsize(12),
                                                                sector.index = sector.name,
                                                                track.index = 2,
                                                                labels.niceFacing = TRUE,
                                                                labels.pos.adjust = c(0, 0.8))
                                                    }
)
dev.off()
```

### Gráficos por estados

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean más interpretables. 

```{r, results = 'hide', eval = FALSE}
tabla <- Migrantes %>%
          as.data.frame() %>%
           expss::cross_cases(ENT, ENT_PAIS_TRAB, weight = Freq) %>%
            as.data.frame() %>%
             slice(-33) %>% 
              select(-row_labels) %>%
               sna::diag.remove(remove.val = 0) 

rownames(tabla) <- stringr::str_wrap(estados, 20)
colnames(tabla) <- stringr::str_wrap(estados, 20)

# Nombre de los estados 
estado <- stringr::str_wrap(estados,20)


################################################################################
###################### Estructura de los colores  ##############################

# Paleta de colores 
groupColors <- viridis::viridis(32, option = "A")


tabla1 <- lapply(1:32, function(x){
                         tabla  %>%
                          as.data.frame() %>%
                           tibble::rownames_to_column(var = "rn") %>%
                            melt(., id.vars = "rn", variable.name = "cn") %>%
                             mutate(value = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x], value, 0)) %>%
                              dcast(., rn ~ cn, value.var = "value", sum,  na.rm = TRUE) %>%
                               column_to_rownames(., var = "rn") 
  }
)

tabla2 <- lapply(1:32, function(x){
                        chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                      grid.col = groupColors)  %>%
                         mutate(col = ifelse(.$rn %in% estado[x] | .$cn %in% estado[x],.$col, "transparent")) %>%
                          pull(col)
  }
)
```




```{r, eval = FALSE, results='hide'}
circos.clear()
circos.info()
pdf(paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/ChordDiagram de MTrab para cada estado.pdf"), width = 20, height = 20)
for(i in 1:32){
circos.par(start.degree = 90, 
           gap.degree = 3, 
           clock.wise = FALSE,
           track.margin = c(-0.07, 0.1), 
           points.overflow.warning = FALSE)

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             order = union(rownames(estados), colnames(estados)),
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = tabla1[[i]] > 0,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(20),
                                                               col = groupColors,
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 5, 10, 20, 50, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(12),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```


### Gráfico Sankey


```{r, eval = FALSE}
# Claves de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

## Población ocupada de 15 años y más 
MC <- mydata %>%
       as.data.frame() %>%
        mutate(EDAD = as.numeric(.$EDAD)) %>%
         subset((EDAD >= 15 & EDAD != 999) & (CONACT >= 10 & CONACT <= 20)) %>%
          filter(ENT_PAIS_TRAB %in% tablas) %>%  # Filtro del lugar de trabajo dentro del país. 
           svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

## Variable `Migrantes`  se vuelve a recalcular. 
Migrantes <- svytable(~CVE_ENT + ENT_PAIS_TRAB, design = MC)  


# Para evitar estar recalculando el muestreo complejo, se le nombra como un data.frame a la variable `Migrantes`  previamente calculada.
# Se remueve la diagonal para quedarnos con los flujos migratorios a nivel estatal.  
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, ENT_PAIS_TRAB, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) %>% 
                   sna::diag.remove(remove.val = 0)

estados <- est 

rownames(Migrantes) <- estados
colnames(Migrantes) <- estados
```



```{r, eval = FALSE}
# Matiz migración laboral (Población ocupada de 15 años y más)
tabla <- Migrantes %>% 
          as.data.frame() %>%
           tibble::rownames_to_column(var = "rn") %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             as_tibble() %>%
              mutate(rn = forcats::fct_relevel(.$rn, estados),
                     cn = forcats::fct_relevel(.$cn, estados)) %>%
               filter(value >= 0)   
```


```{r, eval = FALSE}
p <- tabla %>% 
       ggplot(aes(axis1 = rn, 
                   axis2 = cn, 
                    y = value),  # c("value", "freq", "tasa")
               reverse = FALSE, 
                na.rm = TRUE) +
        geom_alluvium(aes(fill = rn),
                       curve_type = "quintic", 
                        color = "transparent", 
                         alpha = 0.85, 
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
          geom_stratum(aes(fill = cn), 
                        color = "white", 
                         alpha = 0.65,  
                          lwd = 0.001, 
                           width = 1/5,
                            reverse = FALSE) +
           geom_text_repel(aes(label = ifelse(after_stat(x) == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""), 
                               fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                            stat = "stratum", 
                             size = 3, 
                              direction = "y", 
                               nudge_x = -.2,
                                min.segment.length = unit(1, "lines"),
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
            geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                             stat = "stratum", 
                              size = 3,
                               direction = "y", 
                                nudge_x = .2, 
                                 force = 1,
                                  force_pull = 0,
                                   family = "montserrat",
                                    reverse = FALSE) +
             theme_void() + 
              theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                     text = element_text(family = "montserrat"),
                      axis.text = element_blank(),
                       axis.title = element_blank(),
                        strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                         legend.key.size = unit(0.5, "cm"),
                          legend.text = element_text(size = 9, family = "montserrat"),
                           legend.position = c(1, .5)) + 
               scale_x_discrete(expand = c(-0.1, 0.35)) +
                scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                 guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                  labs(fill = "", 
                       color = "")

path = paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/GSankey de MTrab a nivel estatal.pdf")
ggexport(p, width = 14, height = 10, dpi = 400, filename = path)
```

**Desagregado por estado**

```{r, eval = FALSE}
p <- lapply(1:32, function(x){
                   tabla <- tabla %>%
                             mutate(rn = forcats::fct_relevel(.$rn, estados),
                                    cn = forcats::fct_relevel(.$cn, estados)) %>%
                              mutate(value = ifelse(.$rn %in% estados[x] | .$cn %in% estados[x], value, 0)) 
 
                    tabla %>% 
                     ggplot(aes(axis1 = rn, 
                                 axis2 = cn, 
                                  y = value),  # c("value", "freq", "tasa")
                             reverse = FALSE, 
                              na.rm = TRUE) + 
                      geom_alluvium(aes(fill = rn),  
                                     color = "transparent", 
                                      alpha = 0.8, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                       geom_stratum(aes(fill = rn), 
                                     color = "#F1F1F1", 
                                      alpha = 1, 
                                       lwd = 0.001, 
                                        width = 1/5,
                                         reverse = FALSE) +
                         geom_text_repel(aes(label = ifelse(after_stat(x)  == 1, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                             fontface =  ifelse(after_stat(x) == 1, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = -.2, 
                                               force = 1,
                                                        force_pull = 0,
                                                         family = "montserrat",
                                                          reverse = FALSE) +
                          geom_text_repel(aes(label = ifelse(after_stat(x)  == 2, paste0(as.character(after_stat(stratum)),  ": ", prettyNum(count, big.mark = " ")), ""),
                                              fontface =  ifelse(after_stat(x) == 2, 'bold', 'plain')),
                                           stat = "stratum", 
                                            size = 3,
                                             direction = "y", 
                                              nudge_x = .2, 
                                               force = 1,
                                                force_pull = 0,
                                                 family = "montserrat",
                                                  reverse = FALSE) +
                            theme_void() + 
                             theme(plot.margin = margin(t = 1, r = 1.5, b = 1, l = 0, "cm"),
                                    text = element_text(family = "montserrat"),
                                     axis.text = element_blank(),
                                      axis.title = element_blank(),
                                       strip.text = element_text(size = 10, face = "bold", family = "montserrat"),
                                        legend.key.size = unit(0.5, "cm"),
                                         legend.text = element_text(size = 9, family = "montserrat"),
                                          legend.position = c(1, .5)) + 
                              scale_x_discrete(expand = c(-0.1, 0.35)) +
                               scale_fill_viridis_d(option = "A", end = 0.9, begin = 0.2) +
                                guides(fill = guide_legend(ncol = 1, na.translate = F)) + 
                                 labs(fill = "", 
                                      color = "")
              }
  )

path = paste0(here::here(),"/Graficos/Estado/03_Movilidad laboral/2020/GSankey de MTrab desagregado por estados_Absolutos.pdf")
ggexport(list = p, width = 14, height = 10, dpi = 400, filename = path)
```


## Indicadores {.tabset .tabset-pills}  

Se realizan cálculos generales de migración\
- Residentes\
- Inmigrantes\
- Emigrantes\
- % Inmigrantes\
- % Emigrante\
- Migración bruta\
- Migración Neta\
- % Tasa de migración bruta\
- % Tasa de migración neta  

Se trabaja con la matriz cuadrada, la cual de esta manera no se satura computacionalmente

```{r, eval = FALSE}
# Clave de los estados
tablas <- str_pad(rep(1:32), width = 3, pad = "0")

MC <- mydata  %>%
       select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_TRAB, EDAD, CONACT) %>%
        as.data.frame() %>%
         mutate(EDAD = as.numeric(.$EDAD)) %>%
          filter((EDAD >= 15 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20))  %>%
           mutate(ENT_PAIS_TRAB = case_when(.$ENT_PAIS_TRAB %in% tablas ~.$ENT_PAIS_TRAB,
                                            .$ENT_PAIS_TRAB %nin% tablas ~ "888", #Residencia en otro país
                                            .$ENT_PAIS_TRAB %in% "997" ~ "997",
                                            .$ENT_PAIS_TRAB %in% "998" ~ "999",
                                            .$ENT_PAIS_TRAB %in% "997" ~ "999"))  %>%
           # Se reclasifica la variable de residencia hace 5 años
            mutate(ENT_PAIS_TRAB = case_when(.$ENT_PAIS_TRAB %in% tablas ~.$ENT_PAIS_TRAB)) %>%
             svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)

Migrantes <- svytable(~CVE_ENT + ENT_PAIS_TRAB , design = MC) 

Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_ENT, ENT_PAIS_TRAB, weight = Freq) %>%
                as.data.frame() %>%
                 slice(-33) %>% 
                  select(-row_labels) %>%
                   mutate_if(is.character, is.numeric) 

rownames(Migrantes)<- tablas
colnames(Migrantes) <- tablas
```



```{r, eval = FALSE}
################################################################################
############################ Población total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_ENT) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Población ocupada de 15 años y más ###############################
Pob.ocupada <- mydata %>%
                as.data.frame() %>%
                 mutate(EDAD = as.numeric(.$EDAD)) %>%
                  subset((EDAD >= 15 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                   group_by(CVE_ENT) %>%
                    summarise(Pob.ocupada = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                tidyr::gather(CVE_ENT,Value, -rowname)%>%
                 filter(rowname == CVE_ENT) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################

Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_ENT") %>%
                  melt(., id.vars = "CVE_ENT", variable.name = "ENT_PAIS_TRAB") %>%
                   mutate_at(vars(3), as.numeric) %>%
                    as_tibble() %>%
                     filter(CVE_ENT != ENT_PAIS_TRAB) %>%
                      group_by(CVE_ENT) %>%
                       summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################

Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_ENT") %>%
                 melt(., id.vars = "CVE_ENT", variable.name = "ENT_PAIS_TRAB") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>%
                    filter(CVE_ENT != ENT_PAIS_TRAB) %>%
                     group_by(ENT_PAIS_TRAB) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_ENT" = "ENT_PAIS_TRAB") 

tabla <- Pob.Total %>%
          merge(., Pob.ocupada, by = c("CVE_ENT")) %>%
          merge(., Residentes, by = c("CVE_ENT")) %>%
          merge(., Inmigrantes, by = c("CVE_ENT")) %>%
          merge(., Emigrantes, by = c("CVE_ENT")) %>%
            mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                  Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                  Tasa.Inmig = ((.$Inmigrantes/ 5) /((.$Pob.Total + .$Pob.ocupada) / 2))*1000,
                  Tasa.Emig = ((.$Emigrantes/ 5) /((.$Pob.Total + .$Pob.ocupada) / 2))*1000,
                  Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                  Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(),"/Output/Estado/03_Movilidad laboral/2020/Indicadores de movilidad laboral a nivel estatal 2020.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(),"/Output/Estado/03_Movilidad laboral/2020/Indicadores de movilidad laboral a nivel estatal 2020.RData"))
```

```{r, echo = FALSE}
load(file = paste0(here::here(),"/Output/Estado/03_Movilidad laboral/2020/Indicadores de movilidad laboral a nivel estatal 2020.RData"))

tabla %>%  
 as.data.frame() %>%
  gt() %>%  
   tab_header(title = "Indicadores de  migración laboral",  
              subtitle = "Nivel estatal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
      tab_style(style = list(cell_text(align = "center",
                                       weight = 'bold')),
                locations = list(cells_title(groups = c("title")))) %>%
       fmt_integer(columns = c(2:8, 12), sep_mark = " ") %>%
        fmt_number(columns = c(9:11), decimals = 1) %>%
         sub_missing(columns = everything(), missing_text = "0") %>%
          tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
           as_raw_html()
```

# Nivel municipal {.tabset .tabset-pills}

## Movilidad laboral


```{r, eval = FALSE}
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

#Clave de los municipios 2020 
municipios <- mydata %>%
               select(CVE_MUN) %>%
                unique() %>%
                 filter(CVE_MUN %nin% municipios_nomuestra) %>%
                  pull(CVE_MUN)

Pob.ocupada <- mydata %>%
                mutate(CVE_MUN_TRABAJO = paste0(ENT_PAIS_TRAB, MUN_TRAB)) %>%
                 mutate(ENT_PAIS_TRAB = case_when(.$ENT_PAIS_TRAB %in% estados ~.$ENT_PAIS_TRAB,
                                                  .$ENT_PAIS_TRAB %nin% estados ~ "888", #Residencia en otro país
                                                  .$ENT_PAIS_TRAB %in% "997" ~ "997",
                                                  .$ENT_PAIS_TRAB %in% "998" ~ "998",
                                                  .$ENT_PAIS_TRAB %in% "997" ~ "999"),
                        CVE_MUN_TRABAJO = case_when(.$CVE_MUN_TRABAJO %in% municipios ~.$CVE_MUN_TRABAJO,
                                                  #### Se excluyen los municipios que no fueron muestreados
                                                    .$CVE_MUN_TRABAJO %in% municipios_nomuestra ~ "777",
                                                     nchar(.$CVE_MUN_TRABAJO) == 3 ~ "888",  #Residencia en otro país
                                                    .$CVE_MUN_TRABAJO %in% "997999" ~ '997999',
                                                    .$ENT_PAIS_TRAB %in% "997" ~ "997",
                                                    .$ENT_PAIS_TRAB %in% "998" ~ "998",
                                                    .$ENT_PAIS_TRAB %in% "999" ~ "999",
                                                    .$MUN_TRAB %in% "999" ~ "999")) %>%
                  mutate(EDAD = as.numeric(.$EDAD)) %>%
                   subset((EDAD >= 15 & EDAD != 999) & (CONACT >= 10 & CONACT <= 20)) %>%
                    select(FACTOR, ESTRATO, UPM, CVE_MUN, CVE_MUN_TRABAJO, EDAD, CONACT) %>%
                     filter(CVE_MUN_TRABAJO %in% municipios) 

MC <- Pob.ocupada %>%
       svydesign(data = ., id = ~ UPM, strata = ~ESTRATO, weight = ~FACTOR, nest = T)
saveRDS(MC, file = paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/MC_municipio.RDS"))
```


```{r, eval = FALSE}
MC <- readRDS(file = paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/MC_municipio.RDS"))
Migrantes <- svytable(~CVE_MUN_TRABAJO + CVE_MUN, design = MC) 
```


Se genera la matriz cuadrada y se le asignan los nombres de los estados.  

```{r, eval = FALSE}
Migrantes <- Migrantes %>%
              as.data.frame() %>%
               expss::cross_cases(CVE_MUN, CVE_MUN_TRABAJO, weight = Freq) %>%
                as.data.frame() %>%
                 rename("CVE_MUN" = "row_labels") %>% 
                  arrange(CVE_MUN) %>%
                   slice(-1) 

rownames <- Migrantes %>% 
             mutate(CVE_MUN = substr(.$CVE_MUN, 9, 16)) %>% 
              pull(CVE_MUN)

colnames <- names(Migrantes) %>% 
             as.data.frame() %>% 
              slice(-1) %>% 
               rename("CVE_MUN" = ".") %>%
                mutate(`CVE_MUN` = substr(.$CVE_MUN, 17, 22)) %>%
                 pull(CVE_MUN)

# Se elimina la variable CVE_MUN
Migrantes <- Migrantes %>%
              select(-CVE_MUN)

rownames(Migrantes) <- rownames
colnames(Migrantes) <- colnames

saveRDS(Migrantes, file = paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/Matriz de migracion laboral a nivel municipal 2020.RDS"))
save(Migrantes, file = paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/Matriz de migracion laboral a nivel municipal 2020.RData"))

require(openxlsx)
wb <- createWorkbook()
addWorksheet(wb, "M.Laboral")
writeData(wb, 1, Migrantes %>% as.data.frame() %>% tibble::rownames_to_column(var = "CVE_MUN"), colNames = TRUE)
saveWorkbook(wb, file = paste0(here::here(),"/Bases/Municipio/03_Movilidad laboral/2020/Matriz de migracion laboral a nivel municipal.xlsx"), overwrite = TRUE)
```


**Matriz de migración laboral hace 5 años a nivel municipal, 2015 - 2020**  


<div style="height:500px;overflow:auto;">
```{r, echo = FALSE}
load(paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/Matriz de migracion laboral a nivel municipal 2020.RData"))

tabla <- Migrantes %>%
          as.data.frame() %>%
           tibble::rownames_to_column(var = "CVE_MUN") %>%
            mutate_if(is.numeric, as.numeric)

tabla[1:30, 1:30] %>%  
 gt() %>% 
  tab_header(title = "Matriz de migración laboral", 
             subtitle = "Nivel municipal") %>%
   tab_options(heading.title.font.size = 12, 
               heading.align = "center",
               heading.subtitle.font.size = 10,
               data_row.padding = px(1),
               column_labels.font.weight = "bold",
               column_labels.padding = px(10), 
               table.font.names = 'montserrat',
               table.font.size = 8) %>%
    tab_style(style = list(cell_text(align = "center",
                                     weight = 'bold')),
              locations = list(cells_title(groups = c("title")))) %>%
     sub_missing(columns = everything(), missing_text = "0") %>%
      tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
       as_raw_html()
```



## Gráficos migración laboral 

#### Gráficos por municipios

Se filtran los flujos migratorios que son exclusivos de los estados y que visualmente sean más interpretables. 

```{r, results = FALSE, eval = FALSE}
# Matriz cuadrada a nivel municipal 
load(paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/Matriz de migracion laboral a nivel municipal 2020.RData"))

# Nombre de los estados 
nom_estados <- sjlabelled::get_labels(mydata$ENT)
estados <- str_pad(rep(1:32), width = 3, pad = "0")


tabla <- Migrantes %>%
          as.data.frame() %>%
           sna::diag.remove(remove.val = 0) %>%
            melt(., id.vars = "rn", variable.name = "cn") %>%
             mutate(Var1 = str_pad(.$Var1, width = 6, side = c("left"), pad = "0"),
                    Var2 = str_pad(.$Var2, width = 6, side = c("left"), pad = "0")) %>%
              rename("CVE_MUN" = "Var1", 
                     "CVE_MUN_RES" = "Var2") 

## Se generan los filtros correspondientes a la matriz cuadrada por estados 
tabla1 <-  lapply(1:32, function(x){
                   tabla %>%
                 # Se reestructura la clave de municipios y se seleccionan solo los municipios del filtro del estado
                    mutate(CVE_MUN = case_when(substr(.$CVE_MUN, 1, 3) %in% estados[x] ~ .$CVE_MUN, 
                                               substr(.$CVE_MUN, 1, 3) %nin% estados[x] ~ substr(.$CVE_MUN, 1, 3)),
                           CVE_MUN_RES = case_when(substr(.$CVE_MUN_RES, 1, 3) %in% estados[x] ~ .$CVE_MUN_RES, 
                                                   substr(.$CVE_MUN_RES, 1, 3) %nin% estados[x] ~ substr(.$CVE_MUN_RES, 1,3))) %>%
                 # Se seleccionan los valores de la entidad seleccionada
                     mutate(value = ifelse(substr(.$CVE_MUN, 1, 3) %in% estados[x] | substr(.$CVE_MUN_RES, 1, 3) %in% estados[x], value, 0)) %>%
                 # Se cambian las etiquetas a los estados 
                      mutate(CVE_MUN = case_when(substr(.$CVE_MUN, 1, 3) %in% estados[x] ~ .$CVE_MUN,
                                                 substr(.$CVE_MUN, 1, 3)  %nin% estados[x] ~ paste0(nom_estados[as.numeric(substr(.$CVE_MUN, 1, 3))])),
                             CVE_MUN_RES = case_when(substr(.$CVE_MUN_RES, 1, 3) %in% estados[x] ~ .$CVE_MUN_RES,
                                                     substr(.$CVE_MUN_RES, 1, 3)  %nin% estados[x] ~ paste0(nom_estados[as.numeric(substr(.$CVE_MUN_RES, 1, 3))]))) %>%
  ################################## Filtro #####################################
                 # Se hace un filtro de los flujos migratorios arriba de 1 000 habitantes
                       mutate(value = ifelse(.$value >= 1000, value, 0)) %>%
                        dcast(., CVE_MUN ~ CVE_MUN_RES, value.var = "value", sum,  na.rm = TRUE) %>%
                         column_to_rownames(., var = "CVE_MUN") 
}
)
saveRDS(tabla1, file = paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/Tablas a nivel municipal_chordDiagram.RDS"))
```

**Dada la magnitud de municipios en algunos estados se seleccionan solo algunos de ellos.**


```{r, eval = FALSE}
## Genera una lista de vectores con los colores a nivel municipal 
tabla2 <- lapply(1:32, function(x){
                  groupColors <- viridis::viridis(n = ncol(tabla1[[x]]), option = "A")
                  rownames <- rownames(tabla1[[x]])
                  colnames <- colnames(tabla1[[x]])
                  circos.clear()
                  chordDiagram(x  = tabla1[[x]] %>% as.matrix(), 
                                grid.col = groupColors)  %>%
                    mutate(col = ifelse(.$rn %in% rownames | .$cn %in% colnames,.$col, "transparent")) %>%
                      pull(col)
  }
)

saveRDS(tabla2, file = paste0(here::here(), "/Output/Municipio/03_Movilidad laboral/2020/Paleta de colores a nivel municipal_chordDiagram.RDS"))

pdf(paste0(here::here(),"/Graficos/Municipio/03_Movilidad laboral/2020/ChordDiagram de MTrab desagregado por estado.pdf"), width = 20, height = 20)
for(i in 1:32){
circos.clear()
  
# Estuctura de colores
groupColors <- viridis::viridis(nrow(tabla1[[i]]), option = "A")

circos.par(start.degree = 90, 
           gap.degree = 2, 
           clock.wise = FALSE,
           track.margin = c(-0.07, 0.1), 
           points.overflow.warning = FALSE)

chordDiagram(x  =  tabla1[[i]] %>% as.matrix(), 
             grid.col = groupColors,
             col = tabla2[[i]],
             keep.diagonal = FALSE,
             transparency =  0,
             directional = 1,
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, # adjust the starting end of the link
             annotationTrack = "grid", 
             annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = 1, 
             big.gap = 40, # Gap between row sectors and column sectors.
             link.arr.type = "big.arrow", 
             link.lwd = 3,    # Line width width for link borders
             link.lty = 1,
             link.visible = TRUE,
             link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(track.index = 1,
                       track.height = 0.05,
                       bg.border = NA, 
                       panel.fun = function(x, y) {
                                                   xlim = get.cell.meta.data("xlim")
                                                   ylim = get.cell.meta.data("ylim")
                                                   sector.name = get.cell.meta.data("sector.index")
                                                  # Add names to the sector. 
                                                   circos.text(x = mean(xlim), 
                                                               y = ylim[1] + 0.1, 
                                                               labels = sector.name, 
                                                               facing = "clockwise",
                                                               niceFacing = TRUE, 
                                                               adj = c(-0.05, 0.5), #Ajuste de las etiquetas (x, y)
                                                               cex = fontsize(20),
                                                               col = groupColors,
                                                               font = 1)
                                                  # Add graduation on axis
                                                   circos.axis(h = "top",
                                                               labels = c(0, 100, 200, 300, 400, 500, seq(1000, 20000, by = 1000)),
                                                               major.tick.length = 0.5,
                                                               minor.ticks = 4, 
                                                               labels.cex = fontsize(12),
                                                               sector.index = sector.name,
                                                               track.index = 2,
                                                               labels.niceFacing = TRUE,
                                                               labels.pos.adjust = c(0, 0.8))
                                                }
  )
}
dev.off()
```



## Indicadores {.tabset .tabset-pills}  

Se realizan cálculos generales de migración    
- Residentes  
- Inmigrantes     
- Emigrantes      
- % Inmigrantes     
- % Emigrante    
-  Migración Bruta     
-  Migración Neta   
- % Tasa de migración bruta     
- % Tasa de migración neta    


Dada la cantidad de datos a calcular para la obtención de los indicadores. La obtención de los indicadores se realiza de manera directa, es decir, partiendo de la matriz cuadrada original.       


```{r, eval = FALSE}
################################################################################
############################ Población total ###################################
Pob.Total <- mydata %>%
              as.data.frame() %>%
               group_by(CVE_MUN) %>%
                summarise(Pob.Total = sum(FACTOR)) 

################################################################################
###################### Población ocupada de 15 años y más ###############################
Pob.ocupada <- mydata %>%
                as.data.frame() %>%
                 mutate(EDAD = as.numeric(.$EDAD)) %>%
                  subset((EDAD >= 15 & EDAD <= 130) & (CONACT >= 10 & CONACT <= 20)) %>%
                   group_by(CVE_MUN) %>%
                    summarise(Pob.ocupada = sum(FACTOR)) 

################################################################################
########################### Residentes #########################################

Residentes <- Migrantes %>%
               rownames_to_column() %>%
                gather(CVE_MUN, Value, -rowname)%>%
                 filter(rowname == CVE_MUN) %>%
                  select(-rowname) %>%
                   droplevels() %>%
                    rename("Residentes" = "Value") 

################################################################################
############################### Inmigrantes ####################################

Inmigrantes <- Migrantes %>% 
                as.data.frame() %>%
                 tibble::rownames_to_column(var = "CVE_MUN") %>%
                  melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_TRABAJO") %>%
                   mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>%
                    filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                     group_by(CVE_MUN) %>%
                      summarise(Inmigrantes = sum(value, na.rm = TRUE))

################################################################################
############################### Emigrantes #####################################

Emigrantes <- Migrantes %>% 
               as.data.frame() %>%
                tibble::rownames_to_column(var = "CVE_MUN") %>%
                 melt(., id.vars = "CVE_MUN", variable.name = "CVE_MUN_TRABAJO") %>%
                  mutate_at(vars(3), as.numeric) %>%
                   as_tibble() %>%
                    filter(CVE_MUN != CVE_MUN_TRABAJO) %>%
                     group_by(CVE_MUN_TRABAJO) %>%
                      summarise(Emigrantes = sum(value, na.rm = TRUE)) %>%
                       rename("CVE_MUN" = "CVE_MUN_TRABAJO") 

tabla <- Pob.Total %>%
          merge(., Pob.ocupada, by = c("CVE_MUN")) %>%
          merge(., Residentes, by = c("CVE_MUN")) %>%
          merge(., Inmigrantes, by = c("CVE_MUN")) %>%
          merge(., Emigrantes, by = c("CVE_MUN")) %>%
            mutate(Mig.Neta = .$Inmigrantes - .$Emigrantes,
                   Mig.Bruta = .$Inmigrantes + .$Emigrantes, 
                   Tasa.Inmig = ((.$Inmigrantes/ 5) /((.$Pob.Total + .$Pob.ocupada) / 2)) * 1000,
                   Tasa.Emig = ((.$Emigrantes/ 5) /((.$Pob.Total + .$Pob.ocupada) / 2)) * 1000,
                   Tasa.Mig = Tasa.Inmig - Tasa.Emig, 
                   Eficacia = Mig.Neta - Mig.Bruta)

write.xlsx(tabla, file = paste0(here::here(),"/Output/Municipio/03_Movilidad laboral/2020/Indicadores de migracion laboral a nivel municipal.xlsx"), overwrite = TRUE)

save(tabla, file = paste0(here::here(),"/Output/Municipio/03_Movilidad laboral/2020/Indicadores de migracion laboral a nivel municipal.RData"))
```


```{r, echo = FALSE}
load(file = paste0(here::here(),"/Output/Municipio/03_Movilidad laboral/2020/Indicadores de migracion laboral a nivel municipal.RData"))

tabla[1:20,] %>%  
 as.data.frame() %>%
  gt() %>% 
   tab_header(title = "Indicadores de  migración laboral", 
              subtitle = "Nivel municipal") %>%
    tab_options(heading.title.font.size = 12, 
                heading.align = "center",
                heading.subtitle.font.size = 10,
                data_row.padding = px(1),
                column_labels.font.weight = "bold",
                column_labels.padding = px(10), 
                table.font.names = 'montserrat',
                table.font.size = 8) %>%
     tab_style(style = list(cell_text(align = "center",
                                      weight = 'bold')),
               locations = list(cells_title(groups = c("title")))) %>%
      fmt_integer(columns = c(2:8, 12), sep_mark = " ") %>%
       fmt_number(columns = c(11), decimals = 1) %>%
        sub_missing(columns = everything(), missing_text = "0") %>%
         tab_footnote(footnote = "Fuente: Estimaciones del CONAPO.") %>%  
          as_raw_html()
```


# Referencias

Librerias que se usaron en el documento

```{r, echo = FALSE}
sesion_info <- devtools::session_info()
kable(dplyr::select(tibble::as_tibble(sesion_info$packages %>% dplyr::filter(attached == TRUE)),
                    c(package, loadedversion, source))) %>%
 kable_styling(font_size = 10, 
               bootstrap_options = c("condensed", "responsive", "bordered")) %>%
  kable_classic(full_width = TRUE, html_font = "montserrat") %>% 
   scroll_box(width = "100%", height = "150px") %>%  
    gsub("font-size: initial !important;", "font-size: 10pt !important;", .)
```


